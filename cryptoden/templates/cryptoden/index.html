{% load static %}
<script src="{% static 'js/ciphers.js' %}"></script>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/76d03bfb37.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'styles/cryptoden-style.css' %}">
    <link rel="shortcut icon" type="image/x-icon" href="">
    <title>Textual Cryptography</title>
</head>
<body>
    <div class="pattern" style="background-image: url('{{ pages.background.url }}');">
        <div class="container">
            <div class="row text-center">
                <div class="col-md">
                    <div class="p-4">
                        <h1>Textual Cryptography</h1>
                    </div>
                </div>
            </div>
            <div class="card-c">
                <div class="row">
                    <div class="col-md">
                        <div class="m-3">
                            <h3>Options</h3>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-4">
                                <div class="settings d-flex flex-column p-4">
                                    <label for="operation-select">Method</label>
                                    <label for="cipher-select">Cipher</label>
                                </div>
                            </div>
                            <div class="col-8">
                                <div class="settings d-flex flex-column p-4">
                                    <select id="operation-select" onchange="updateCiphers(); updateOperationDescription(); updateCipherDescription(); updateCipherKey();">
                                        {% for operation in operations %}
                                        {% comment %} temporary: to only show the first method of cipher operation {% endcomment %}
                                            {% if forloop.first %}
                                                <option value="{{ operation.id }}">{{ operation.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                    <select id="cipher-select" onchange="updateCipherDescription(); updateCipherKey();">
                                        <option value="">Select Operation First</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-3">
                                <div class="p-4">
                                    <label for="">Keys</label>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="keys p-4">
                                    <div id="key-none" style="display: none;">
                                        <input disabled placeholder="No Key Required">
                                    </div>
                                    <div id="key-caesar" style="display: none;">
                                        <input id="caesar-key" type="number" pattern="\d{2}" title="Only 2 digits allowed" placeholder="i.e. 1-25" oninput="validateInput(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="m-4">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="p-text form-floating">
                                <textarea class="form-control" placeholder="Type your plaintext here" id="plainTextarea" style="height: 100%"></textarea>
                                <label for="plainTextarea">Plaintext</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="ed-btns d-flex align-items-center">
                                <button id="encryptBtn" class="btn btn-light p-2 m-2">Encrypt</button>
                                <button class="btn btn-light p-2 m-2">Decrypt</button>
                                <button class="btn btn-light p-1 m-4">Clear</button>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="c-text form-floating">
                                <textarea class="form-control" placeholder="Type your ciphertext here" id="cipherTextarea" style="height: 100%"></textarea>
                                <label for="cipherTextarea">Encrypted Text</label>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md">
                        <div class="m-3">
                            <h3>Description</h3>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md">
                        <div class="p-4">
                            <p id="operation-desc">"op-desc"</p>
                        </div>
                        <div class="text-center">
                            <h5>Implementation</h5>
                        </div>
                        <div class="p-4">
                            <p id="cipher-desc">"ci-desc"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md">
                    <div class="social-list m-4">
                        <a href="{{profile.social_linkedin}}" target="_blank"><i class="fa-brands fa-linkedin fa-2xl"></i></a>
                        <a href="{{profile.social_github}}" target="_blank"><i class="fa-brands fa-square-github fa-2xl"></i></a>
                        <p class="mt-3">Copyright Â©{% now 'Y' %} All rights reserved. Developed by <a href="https://msrezaie.pythonanywhere.com/" target="_blank">MSREZAIE</a></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</body>
<script>
    var operations = {
        {% for operation in operations %}
        {{ operation.id }}: [
            {% for cipher in operation.cipher.all %}
            "{{ cipher.name }}",
            {% endfor %}
        ],
        {% endfor %}
    };

    var operationDescs = {
        {% for operation in operations %}
        {{ operation.id }}:"{{ operation.desc }}",
        {% endfor %}
    };

    var cipherDescs = {
        {% for operation in operations %}
            {% for cipher in operation.cipher.all %}
                "{{ cipher.name }}":"{{ cipher.desc|escapejs }}",
            {% endfor %}
        {% endfor %}
    };

    var cipherSelect = document.getElementById("cipher-select");

    function updateCiphers() {
        var operationId = document.getElementById("operation-select").value;
        var ciphers = operations[operationId];
    
        cipherSelect.innerHTML = "";
        if (ciphers) {
            for (var i = 0; i < ciphers.length; i++) {
                cipherSelect.innerHTML += "<option value='" + ciphers[i] + "'>" + ciphers[i] + "</option>";
            }
        } else {
            cipherSelect.innerHTML = "<option value=''>Select Operation First</option>";
        }
    }
    
    function updateOperationDescription() {
        var operationId = document.getElementById("operation-select").value;
        var operationDesc = document.getElementById("operation-desc");
        var desc = operationDescs[operationId];

        operationDesc.innerHTML = desc;
    }

    function updateCipherDescription() {
        var cipherName = document.getElementById("cipher-select").value;
        var cipherDesc = document.getElementById("cipher-desc");
        var desc = cipherDescs[cipherName];
        
        cipherDesc.innerHTML = desc;
    }

    var cipherKeyMap = {
        "Caesar": "key-caesar",
        "Atbash": "key-none",
    };

    function updateCipherKey() {
        var selectedCipher = cipherSelect.value;
        var selectedCipherKeyDiv = cipherKeyMap[selectedCipher];
        var keyInputDiv = document.querySelectorAll(".keys div");

        for (var i = 0; i < keyInputDiv.length; i++) {
            keyInputDiv[i].style.display = "none";
        }
        
        document.getElementById(selectedCipherKeyDiv).style.display = "block";
    }

    function validateInput(input) {
        if (input.value > 25) {
            input.value = 25;
        }
    }

    function encrypt() {
        let plainText = document.getElementById("plainTextarea").value;
        let caesarKey = document.getElementById("caesar-key").value;

        // send the input to the views.py using AJAX
        const xhr = new XMLHttpRequest();
        xhr.open("POST", window.location.href, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            // get the response and display it in the cipherTextarea
                document.getElementById("cipherTextarea").value = this.responseText;
            }
        };
        xhr.send(`plainText=${plainText}&caesarKey=${caesarKey}`);
    }
    
    document.getElementById("encryptBtn").addEventListener("click", encrypt);

    updateCiphers();
    updateOperationDescription();
    updateCipherDescription();
    updateCipherKey();
</script>
</html>